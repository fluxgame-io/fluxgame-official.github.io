<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>DETECTIVE KABIR: ULTIMATE</title>
    <style>
        body { margin: 0; overflow: hidden; background: #000; font-family: 'Courier New', monospace; touch-action: none; }
        #ui-layer { position: fixed; width: 100%; height: 100%; pointer-events: none; z-index: 10; color: white; }
        .hud { position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.7); padding: 10px; border: 1px solid #00f2ff; pointer-events: none; }
        #crosshair { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 20px; }
        
        /* Mobile/Touch Controls */
        #controls { position: absolute; bottom: 20px; width: 100%; display: flex; justify-content: space-around; pointer-events: auto; }
        .btn { width: 60px; height: 60px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; user-select: none; border: 2px solid white; }
        #start-screen { position: fixed; width: 100%; height: 100%; background: #000; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        #start-btn { padding: 20px 50px; font-size: 24px; color: white; background: #0088ff; border: none; cursor: pointer; border-radius: 10px; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="color:white">DETECTIVE KABIR</h1>
        <button id="start-btn">KHEL SHURU KAREIN</button>
        <p style="color:#888; margin-top:10px;">WASD or Buttons to Move | Mouse or Touch to Look</p>
    </div>

    <div id="ui-layer">
        <div class="hud">
            <b>CASE: SILENT HOUSE</b><br>
            [H] Interact | [F] Torch<br>
            Code: <span id="code-status">Dhoondo...</span>
        </div>
        <div id="crosshair">+</div>
        <div id="controls">
            <div class="btn" id="btn-w">W</div>
            <div class="btn" id="btn-a">A</div>
            <div class="btn" id="btn-s">S</div>
            <div class="btn" id="btn-d">D</div>
            <div class="btn" style="background:red" id="btn-h">H</div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

    <script>
        let scene, camera, renderer, player, torch, flowerPot, door;
        let move = { f: 0, r: 0 };
        let colliders = [], hasCode = false, isExamining = false;

        function init() {
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x111111);
            scene.fog = new THREE.Fog(0x111111, 2, 25);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
            player = new THREE.Group();
            player.add(camera);
            scene.add(player);
            player.position.set(0, 1.6, 8);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Lighting
            const ambient = new THREE.AmbientLight(0xffffff, 0.4);
            scene.add(ambient);
            const light = new THREE.PointLight(0xffffff, 1.5, 20);
            light.position.set(0, 4, -5);
            scene.add(light);

            // Floor
            const floor = new THREE.Mesh(new THREE.PlaneGeometry(50, 50), new THREE.MeshStandardMaterial({ color: 0x222222 }));
            floor.rotation.x = -Math.PI/2;
            floor.receiveShadow = true;
            scene.add(floor);

            // Room Architecture (Solid Walls)
            createWall(0, 2, -10, 15, 5); // Back
            createWall(-7.5, 2, 0, 20, 5, true); // Left
            createWall(7.5, 2, 0, 20, 5, true); // Right

            // The Mystery Door
            door = new THREE.Mesh(new THREE.BoxGeometry(4, 6, 0.4), new THREE.MeshStandardMaterial({color: 0x4a2c16}));
            door.position.set(0, 1, 0);
            scene.add(door);
            colliders.push(door);

            // Table and Pot
            const table = new THREE.Mesh(new THREE.BoxGeometry(3, 1, 1.5), new THREE.MeshStandardMaterial({color: 0x3d2b1f}));
            table.position.set(0, -0.5, -6);
            scene.add(table);
            colliders.push(table);

            flowerPot = new THREE.Mesh(new THREE.CylinderGeometry(0.3, 0.2, 0.5), new THREE.MeshStandardMaterial({color: 0xcd853f}));
            flowerPot.position.set(0, 0.2, -6);
            scene.add(flowerPot);

            animate();
        }

        function createWall(x, y, z, w, h, rot=false) {
            const wall = new THREE.Mesh(new THREE.BoxGeometry(rot?0.5:w, h, rot?w:0.5), new THREE.MeshStandardMaterial({color: 0x555555}));
            wall.position.set(x, y, z);
            scene.add(wall);
            colliders.push(wall);
        }

        // Logic for Controls
        const handleKeys = (key, val) => {
            if(key === 'w') move.f = val;
            if(key === 's') move.f = -val;
            if(key === 'a') move.r = -val;
            if(key === 'd') move.r = val;
        };

        window.addEventListener('keydown', (e) => handleKeys(e.key.toLowerCase(), 1));
        window.addEventListener('keyup', (e) => handleKeys(e.key.toLowerCase(), 0));

        // Start Button
        document.getElementById('start-btn').addEventListener('click', () => {
            document.getElementById('start-screen').style.display = 'none';
            document.body.requestPointerLock();
            init();
        });

        // Touch/Button Controls
        const bindBtn = (id, k) => {
            const el = document.getElementById(id);
            el.addEventListener('pointerdown', () => handleKeys(k, 1));
            el.addEventListener('pointerup', () => handleKeys(k, 0));
        };
        bindBtn('btn-w', 'w'); bindBtn('btn-s', 's'); bindBtn('btn-a', 'a'); bindBtn('btn-d', 'd');
        document.getElementById('btn-h').addEventListener('click', interact);

        function interact() {
            if(player.position.distanceTo(flowerPot.position) < 3) {
                hasCode = true;
                document.getElementById('code-status').innerText = "1045 MIL GAYA!";
                flowerPot.position.y = 2; // Pot uth gaya
            }
            if(player.position.distanceTo(door.position) < 3 && hasCode) {
                door.position.x = 5;
                colliders = colliders.filter(c => c !== door);
            }
        }

        function animate() {
            requestAnimationFrame(animate);
            if(move.f !== 0 || move.r !== 0) {
                let speed = 0.12;
                let dir = new THREE.Vector3(move.r, 0, -move.f).normalize().applyQuaternion(player.quaternion);
                let nextPos = player.position.clone().addScaledVector(dir, speed);
                
                // Simple Collision Detection
                let canMove = true;
                for(let wall of colliders) {
                    if (new THREE.Box3().setFromObject(wall).containsPoint(nextPos)) {
                        canMove = false;
                    }
                }
                if(canMove) player.position.copy(nextPos);
            }
            renderer.render(scene, camera);
        }

        document.addEventListener('pointermove', (e) => {
            if(document.pointerLockElement) player.rotation.y -= e.movementX * 0.003;
        });
    </script>
</body>
</html>
